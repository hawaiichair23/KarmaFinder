<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RedditFinder - Better Reddit Search</title>
    <style>
        :root {
            --primary-color: #ff4500;
            --secondary-color: #0079d3;
            --background-color: #f8f9fa;
            --card-color: #ffffff;
            --text-color: #1a1a1b;
            --light-text: #787c7e;
            --border-color: #edeff1;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .tagline {
            font-size: 1.2rem;
            color: var(--light-text);
        }

        .search-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
            background-color: var(--card-color);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .search-input-container {
            display: flex;
            width: 100%;
        }

        .search-input {
            flex-grow: 1;
            padding: 12px 20px;
            font-size: 1.1rem;
            border: 1px solid var(--border-color);
            border-radius: 4px 0 0 4px;
            outline: none;
        }

        .search-input:focus {
            border-color: var(--secondary-color);
        }

        .search-button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            padding: 0 20px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .search-button:hover {
            background-color: #005fa3;
        }

        .advanced-options {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .option-group {
            flex: 1;
            min-width: 200px;
        }

        .option-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .option-group select,
        .option-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .subreddit-dropdown {
            position: relative;
        }

        .subreddit-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
        }

        .subreddit-suggestions.active {
            display: block;
        }

        .subreddit-suggestion {
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .subreddit-suggestion:hover {
            background-color: var(--background-color);
        }

        .subreddit-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .subreddit-icon img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .results-container {
            display: flex;
            position: relative;
            flex-direction: column;
            gap: 15px;
        }

        .result-card {
            position: relative !important;
            margin-bottom: 40px !important; /* Add more space between cards */
            overflow: visible !important; /* Allow comments to overflow */
            display: flex;
            flex-direction: row;
            align-items: center;
            padding: 20px;
            border-radius: 8px;
            background-color: #fff;
            min-height: 100px; 
        }

         .result-card:hover { 
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .vote-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 40px;
        }

        .vote-button {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--light-text);
            transition: color 0.2s;
        }

        .vote-button:hover {
            color: var(--secondary-color);
        }

        .vote-count {
            font-weight: bold;
            margin: 5px 0;
        }

        .content-section {
            flex-grow: 1;
            overflow: hidden;
            margin-right: 300px;
            margin-left: 15px;
            color: #29213b;
        }

        .result-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
            font-size: 1rem;
            color: var(--light-text);
            color: #15121c;
            font-weight: 400;
        }

        .result-subreddit {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
            color: var(--text-color);
            text-decoration: none;
        }

        .result-subreddit:hover {
            text-decoration: underline;
        }

        .result-author,
        .result-time {
            margin-left: 5px;
        }

        .result-title {
            font-size: 1.2rem;
            margin-bottom: 8px;
            font-weight: 500;
            color: #15121c;
        }

        .result-title a {
            color: var(--text-color);
            text-decoration: none;
        }

        .result-title a:hover {
            color: var(--secondary-color);
        }

        .result-content {
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .result-actions {
            display: flex;
            gap: 15px;
            color: var(--light-text);
        }

        .result-action {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .result-action:hover {
            color: var(--text-color);
        }

        /* Comments section styles */
        .comments-section {

            max-height: 90px;
            overflow-y: auto;
            font-size: small;
            position: absolute !important;
            right: 15px !important;
            top: 0 !important; /* Align with top of card */
            width: 200px !important;
            max-height: 120px !important;
            z-index: 10 !important; /* Higher than other elements */
    
            /* Make sure it's always visible */
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
    
            /* Styling */
            background-color: #f9f9f9 !important;
            border-radius: 6px !important;
            padding: 8px !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
}

        .comments-section::-webkit-scrollbar {
            width: 5px;
        }

        .comments-section::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 5px;
        }

        .comment {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .comment:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .comment-author {
            font-weight: bold;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
        }

        .comment-author-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: var(--light-text);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            margin-right: 5px;
        }

        .comment-text {
            line-height: 1.3;
            word-break: break-word;
        }

        .comment-meta {
            display: flex;
            font-size: 10px;
            color: var(--light-text);
            margin-top: 2px;
        }

        .comment-score {
            margin-right: 6px;
        }

        .comment-time {
            margin-left: auto;
        }

        .loading-comments {
            color: var(--light-text);
            text-align: center;
            font-style: italic;
        }

        .see-more-comments {
            text-align: center;
            padding-top: 5px;
            font-size: 11px;
            color: var(--secondary-color);
            cursor: pointer;
            font-weight: bold;
        }

        .see-more-comments:hover {
            text-decoration: underline;
        }    

        .action-icon {
            vertical-align: middle;
        }

        .result-image {
            max-width: 140px;
            max-height: 100px;
            border-radius: 4px;
            object-fit: cover;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--light-text);
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--secondary-color);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 10px;
        }

        .pagination-button {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        .pagination-button:hover:not(:disabled) {
            background-color: #f0f0f0;
        }

        .pagination-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .filter-chip-container {
            display: none;
            align-items: center;
            background-color: var(--background-color);
            border-radius: 16px;
            padding: 3px 10px;
            gap: 5px;
            margin-top: 5px;
        }

        .filter-chip-container .chip-text {
            font-size: 0.9rem;
        }

        .filter-chip-container .remove-chip {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: var(--light-text);
            color: white;
            font-size: 10px;
            line-height: 1;
        }

        footer {
            margin-top: 40px;
            text-align: center;
            padding: 20px;
            color: var(--light-text);
            font-size: 0.9rem;
        }

        .donate-btn {
            display: inline-block;
            margin-top: 10px;
            background-color: var(--primary-color);
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .donate-btn:hover {
            background-color: #e03d00;
        }

        @media (max-width: 768px) {
            .advanced-options {
                flex-direction: column;
            }

            .result-card {
                flex-direction: column;
            }

            .vote-section {
                flex-direction: row;
                justify-content: center;
                gap: 10px;
            }
        }

        .img-container {
            position: relative;
            width: 140px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .img-container img {
            width: 100%;
            position: relative;
            max-width: 140px;
            max-height: 100px;
            border-radius: 4px;
            object-fit: cover;
        }
        
        .img-container .play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            pointer-events: none;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo">RedditFinder</div>
            <div class="tagline">Find exactly what you're looking for on Reddit</div>
        </header>

        <div class="search-container">
            <div class="search-input-container">
                <input type="text" id="search-input" class="search-input" placeholder="Search Reddit..." autofocus>
                <button id="search-button" class="search-button">Search</button>
            </div>

            <div class="advanced-options">
                <div class="option-group">
                    <label for="sort-select">Sort By</label>
                    <select id="sort-select">
                        <option value="relevance">Relevance</option>
                        <option value="hot">Hot</option>
                        <option value="top">Top</option>
                        <option value="new">New</option>
                        <option value="comments">Comments</option>
                    </select>
                </div>

                <div class="option-group">
                    <label for="time-select">Time Period</label>
                    <select id="time-select">
                        <option value="all">All Time</option>
                        <option value="year">Past Year</option>
                        <option value="month">Past Month</option>
                        <option value="week">Past Week</option>
                        <option value="day">Past 24 Hours</option>
                        <option value="hour">Past Hour</option>
                    </select>
                </div>

                <div class="option-group subreddit-dropdown">
                    <label for="subreddit-input">Subreddit (optional)</label>
                    <input type="text" id="subreddit-input" placeholder="e.g., AskReddit">
                    <div class="subreddit-suggestions" id="subreddit-suggestions"></div>
                    <div class="filter-chip-container" id="subreddit-chip-container">
                        <span class="chip-text"></span>
                        <span class="remove-chip">×</span>
                    </div>
                </div>

                <div class="option-group">
                    <label for="content-select">Content Type</label>
                    <select id="content-select">
                        <option value="all">All Content</option>
                        <option value="posts">Posts Only</option>
                        <option value="comments">Comments Only</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="results" class="results-container">
            <!-- Results will be populated here -->
        </div>

        <div id="pagination" class="pagination">
            <!-- Pagination will be added here -->
        </div>

        <footer>
            <p>RedditFinder helps you search Reddit content more effectively than Reddit's native search.</p>
            <p>If you find this tool useful, please consider supporting its development.</p>
            <a href="#" class="donate-btn">Donate</a>
        </footer>
    </div>

    <script>
        // Configuration
        const API_ENDPOINT = 'https://www.reddit.com';
        const RESULTS_PER_PAGE = 10;

        let searchTimeout = null;

        let POPULAR_SUBREDDITS = [
            { name: 'AskReddit', icon: '/api/placeholder/20/20' },
            { name: 'funny', icon: '/api/placeholder/20/20' },
            { name: 'gaming', icon: '/api/placeholder/20/20' }
            // These are just fallbacks in case the API request fails
        ];

        // Add this function to fetch popular subreddits
        function fetchPopularSubreddits() {
            console.log("Attempting to fetch popular subreddits...");

            // Start with an empty array - we'll populate it completely from the API
            fetch('https://www.reddit.com/subreddits/popular.json?limit=100')
                .then(response => {
                    if (!response.ok) throw new Error('Failed to fetch popular subreddits');
                    return response.json();
                })
                .then(data => {
                    if (data && data.data && data.data.children) {
                        POPULAR_SUBREDDITS = data.data.children.map(child => ({
                            name: child.data.display_name,
                            icon: child.data.icon_img || '/api/placeholder/20/20'
                        }));
                        console.log('Loaded popular subreddits:', POPULAR_SUBREDDITS.length);

                        // Keep some fallbacks only if the API returned nothing
                        if (POPULAR_SUBREDDITS.length === 0) {
                            POPULAR_SUBREDDITS = [
                                { name: 'AskReddit', icon: '/api/placeholder/20/20' },
                                { name: 'funny', icon: '/api/placeholder/20/20' },
                                { name: 'gaming', icon: '/api/placeholder/20/20' }
                            ];
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching popular subreddits:', error);
                });
        }

        // Call this function when the page loads
        document.addEventListener('DOMContentLoaded', fetchPopularSubreddits);

        // DOM Elements
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const sortSelect = document.getElementById('sort-select');
        const timeSelect = document.getElementById('time-select');
        const subredditInput = document.getElementById('subreddit-input');
        const contentSelect = document.getElementById('content-select');
        const resultsContainer = document.getElementById('results');
        const paginationContainer = document.getElementById('pagination');
        const subredditSuggestions = document.getElementById('subreddit-suggestions');
        const subredditChipContainer = document.getElementById('subreddit-chip-container');

        // State
        let currentQuery = '';
        let currentAfter = null;
        let currentBefore = null;
        let isLoading = false;
        let currentFilters = {
            sort: 'relevance',
            time: 'all',
            subreddit: '',
            contentType: 'all'
        };

        // Event Listeners
        searchButton.addEventListener('click', () => performSearch());
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        sortSelect.addEventListener('change', () => {
            currentFilters.sort = sortSelect.value;
        });

        timeSelect.addEventListener('change', () => {
            currentFilters.time = timeSelect.value;
        });

        contentSelect.addEventListener('change', () => {
            currentFilters.contentType = contentSelect.value;
        });

        // Remove subreddit filter when clicking X
        subredditChipContainer.querySelector('.remove-chip').addEventListener('click', () => {
            currentFilters.subreddit = '';
            subredditChipContainer.style.display = 'none';
        });

        // Handle suggestion selection
        subredditSuggestions.addEventListener('click', (e) => {
            const suggestion = e.target.closest('.subreddit-suggestion');
            if (suggestion) {
                const subName = suggestion.getAttribute('data-name');
                selectSubreddit(subName);
            }
        });

        // Handle Enter key in subreddit input
        subredditInput.addEventListener('input', () => {
            const query = subredditInput.value.toLowerCase().trim();

            // Clear any previous timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            // Set a new timeout to delay the search
            searchTimeout = setTimeout(() => {
                if (query.length > 0) {
                    // More restrictive filtering - ONLY include if it starts with the query
                    // This will exclude things like "college" when searching for "leg"
                    const filteredSubs = POPULAR_SUBREDDITS.filter(sub => {
                        const name = sub.name.toLowerCase();
                        return name.startsWith(query) || name === query;
                    }).sort((a, b) => {
                        const aName = a.name.toLowerCase();
                        const bName = b.name.toLowerCase();

                        // Exact matches first
                        if (aName === query && bName !== query) return -1;
                        if (bName === query && aName !== query) return 1;

                        // Then alphabetical
                        return aName.localeCompare(bName);
                    });

                    // Show matching subreddits
                    populateSubredditSuggestions(filteredSubs);
                    subredditSuggestions.classList.add('active');

                    // Also fetch subreddit suggestions specific to the query - but modify that too
                    // to be more strict
                    fetchSubredditSuggestions(query);
                } else {
                    // Show some popular subreddits if query is empty
                    populateSubredditSuggestions(POPULAR_SUBREDDITS.slice(0, 10));
                    subredditSuggestions.classList.add('active');
                }
            }, 300); // Wait 300ms after typing stops before searching
        });

        function fetchSubredditSuggestions(query) {
            console.log("Searching for subreddits containing:", query);

            // Use Reddit's API to search for subreddits matching the query
            fetch(`https://www.reddit.com/subreddits/search.json?q=${encodeURIComponent(query)}&limit=10`)
                .then(response => {
                    if (!response.ok) throw new Error('Failed to search subreddits');
                    return response.json();
                })
                .then(data => {
                    if (data && data.data && data.data.children && data.data.children.length > 0) {
                        // Only keep subreddits that start with the query
                        const searchResults = data.data.children
                            .filter(child => child.data.display_name.toLowerCase().startsWith(query.toLowerCase()))
                            .map(child => ({
                                name: child.data.display_name,
                                icon: child.data.icon_img || '/api/placeholder/20/20'
                            }));

                        console.log('Filtered search results:', searchResults);

                        // Get current suggestion names to avoid duplicates
                        const currentSuggestions = Array.from(subredditSuggestions.children)
                            .map(el => el.getAttribute('data-name'));

                        const newSuggestions = searchResults.filter(sub =>
                            !currentSuggestions.includes(sub.name)
                        );

                        if (newSuggestions.length > 0) {
                            appendSubredditSuggestions(newSuggestions);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error searching subreddits:', error);

                    // For fallback, also be more strict
                    setTimeout(() => {
                        const simulatedResults = [
                            { name: query + 'Pics', icon: '/api/placeholder/20/20' },
                            { name: query + 'Memes', icon: '/api/placeholder/20/20' },
                            { name: query + 'Pro', icon: '/api/placeholder/20/20' }
                        ];

                        const currentSuggestions = Array.from(subredditSuggestions.children)
                            .map(el => el.getAttribute('data-name'));

                        const newSuggestions = simulatedResults.filter(sub =>
                            !currentSuggestions.includes(sub.name)
                        );

                        if (newSuggestions.length > 0) {
                            appendSubredditSuggestions(newSuggestions);
                        }
                    }, 300);
                });
        }

        function populateSubredditSuggestions(subreddits) {
            console.log("Populating subreddit suggestions:", subreddits);

            // Clear the suggestions container first
            subredditSuggestions.innerHTML = '';

            // Sort subreddits by relevance to the search query
            const query = subredditInput.value.toLowerCase().trim();
            if (query.length > 0) {
                subreddits.sort((a, b) => {
                    const aName = a.name.toLowerCase();
                    const bName = b.name.toLowerCase();

                    // Exact matches first
                    if (aName === query && bName !== query) return -1;
                    if (bName === query && aName !== query) return 1;

                    // Then starts with matches
                    if (aName.startsWith(query) && !bName.startsWith(query)) return -1;
                    if (bName.startsWith(query) && !aName.startsWith(query)) return 1;

                    // Then contains matches (already handled by filtering)
                    // Finally alphabetical
                    return aName.localeCompare(bName);
                });
            }

            // If there are results from filtering, add them
            if (subreddits.length > 0) {
                subreddits.forEach(sub => {
                    const suggestion = document.createElement('div');
                    suggestion.className = 'subreddit-suggestion';
                    suggestion.setAttribute('data-name', sub.name);

                    const iconEl = document.createElement('div');
                    iconEl.className = 'subreddit-icon';

                    if (sub.icon && sub.icon !== '/api/placeholder/20/20') {
                        const img = document.createElement('img');
                        img.src = sub.icon;
                        img.alt = sub.name;
                        iconEl.appendChild(img);
                    } else {
                        iconEl.textContent = sub.name.charAt(0).toUpperCase();
                    }

                    suggestion.appendChild(iconEl);
                    suggestion.appendChild(document.createTextNode(sub.name));

                    subredditSuggestions.appendChild(suggestion);
                });
            }

            // Add an attribute to track if we have results
            subredditSuggestions.setAttribute('data-has-results', subreddits.length > 0 ? 'true' : 'false');
        }

        function appendSubredditSuggestions(subreddits) {
            // First, check if we already have results
            const hasResults = subredditSuggestions.getAttribute('data-has-results') === 'true';

            // If we have new suggestions and no existing ones, remove any "no results" message
            if (subreddits.length > 0 && !hasResults) {
                subredditSuggestions.innerHTML = '';
                subredditSuggestions.setAttribute('data-has-results', 'true');
            }

            subreddits.forEach(sub => {
                const suggestion = document.createElement('div');
                suggestion.className = 'subreddit-suggestion';
                suggestion.setAttribute('data-name', sub.name);

                const iconEl = document.createElement('div');
                iconEl.className = 'subreddit-icon';

                if (sub.icon && sub.icon !== '/api/placeholder/20/20') {
                    const img = document.createElement('img');
                    img.src = sub.icon;
                    img.alt = sub.name;
                    iconEl.appendChild(img);
                } else {
                    iconEl.textContent = sub.name.charAt(0).toUpperCase();
                }

                suggestion.appendChild(iconEl);
                suggestion.appendChild(document.createTextNode(sub.name));

                subredditSuggestions.appendChild(suggestion);
            });
        }

        function selectSubreddit(subName) {
            currentFilters.subreddit = subName;
            subredditChipContainer.style.display = 'flex';
            subredditChipContainer.querySelector('.chip-text').textContent = 'r/' + subName;
            subredditInput.value = '';
            subredditSuggestions.classList.remove('active');
        }

        function performSearch(after = null, before = null) {
            const query = searchInput.value.trim();
            if (!query) return;

            currentQuery = query;
            currentAfter = after;
            currentBefore = before;

            showLoading();

            // Build the API URL based on current filters
            let url = '';

            if (currentFilters.subreddit) {
                // For subreddit search, use this format
                url = `${API_ENDPOINT}/r/${currentFilters.subreddit}/search.json?q=${encodeURIComponent(query)}&restrict_sr=1`;
                console.log("Searching in r/" + currentFilters.subreddit + " with URL:", url);
            } else {
                url = `${API_ENDPOINT}/search.json?q=${encodeURIComponent(query)}`;
                console.log("Searching all of Reddit with URL:", url);
            }

            // Add sort parameter
            url += `&sort=${currentFilters.sort}`;

            // Add time parameter for relevant sorts
            if (currentFilters.sort === 'top' || currentFilters.sort === 'comments') {
                url += `&t=${currentFilters.time}`;
            }

            // Add content type filter
            if (currentFilters.contentType === 'comments') {
                url += '&type=comment';
            } else if (currentFilters.contentType === 'posts') {
                url += '&type=link';
            }

            // Add pagination parameters
            url += `&limit=${RESULTS_PER_PAGE}`;
            if (after) {
                url += `&after=${after}`;
            } else if (before) {
                url += `&before=${before}`;
            }

            // Fetch results from Reddit API
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    displayResults(data.data);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    resultsContainer.innerHTML = `
                        <div style="padding: 20px; background-color: var(--card-color); border-radius: 4px;">
                            <p>Sorry, there was an error fetching results.</p>
                            <p>Error details: ${error.message}</p>
                        </div>
                    `;
                    paginationContainer.innerHTML = '';
                })
                .finally(() => {
                    isLoading = false;
                });
        }

        function showLoading() {
            isLoading = true;
            resultsContainer.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading results...</p>
                </div>
            `;
            paginationContainer.innerHTML = '';
        }

        // Function to fetch comments for a post
            function fetchComments(permalink, commentsContainer) {
                commentsContainer.innerHTML = '<div class="loading-comments">Loading comments...</div>';

                // Reddit API URL for comments (no auth required)
                const commentsUrl = `https://www.reddit.com${permalink}.json`;

                fetch(commentsUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to fetch comments');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // The comments are in the second element of the array
                        const commentsData = data[1].data.children;

                        if (commentsData.length === 0) {
                            commentsContainer.innerHTML = '<div class="loading-comments">No comments found</div>';
                            return;
                        }

                        // Sort comments by score (highest first)
                        commentsData.sort((a, b) => (b.data.score || 0) - (a.data.score || 0));

                        // Clear the container
                        commentsContainer.innerHTML = '';

                        // Display top 5 comments
                        const topComments = commentsData.slice(0, 5);
                        topComments.forEach(comment => {
                            if (comment.kind !== 't1') return; // Skip non-comment items

                            const commentData = comment.data;

                            // Create comment element
                            const commentEl = document.createElement('div');
                            commentEl.className = 'comment';

                            // Author section
                            const authorEl = document.createElement('div');
                            authorEl.className = 'comment-author';

                            const authorIconEl = document.createElement('div');
                            authorIconEl.className = 'comment-author-icon';
                            authorIconEl.textContent = commentData.author.charAt(0).toUpperCase();

                            authorEl.appendChild(authorIconEl);
                            authorEl.appendChild(document.createTextNode(commentData.author));

                            // Comment text
                            const textEl = document.createElement('div');
                            textEl.className = 'comment-text';
                            textEl.textContent = commentData.body.length > 150
                                ? commentData.body.substring(0, 150) + '...'
                                : commentData.body;

                            // Comment metadata
                            const metaEl = document.createElement('div');
                            metaEl.className = 'comment-meta';

                            const scoreEl = document.createElement('span');
                            scoreEl.className = 'comment-score';
                            scoreEl.textContent = formatNumber(commentData.score) + ' points';

                            const timeEl = document.createElement('span');
                            timeEl.className = 'comment-time';
                            timeEl.textContent = formatTimestamp(commentData.created_utc);

                            metaEl.appendChild(scoreEl);
                            metaEl.appendChild(timeEl);

                            // Add all elements to comment
                            commentEl.appendChild(authorEl);
                            commentEl.appendChild(textEl);
                            commentEl.appendChild(metaEl);

                            // Add comment to container
                            commentsContainer.appendChild(commentEl);
                        });

                        // Add "See more comments" link if there are more than 5 comments
                        if (commentsData.length > 5) {
                            const seeMoreEl = document.createElement('div');
                            seeMoreEl.className = 'see-more-comments';
                            seeMoreEl.textContent = `See all ${commentsData.length} comments`;

                            seeMoreEl.addEventListener('click', () => {
                                window.open(`https://www.reddit.com${permalink}`, '_blank');
                            });

                            commentsContainer.appendChild(seeMoreEl);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching comments:', error);
                        commentsContainer.innerHTML = '<div class="loading-comments">Failed to load comments</div>';
                    });
            }

        function displayResults(data) {
            resultsContainer.innerHTML = '';

            if (!data.children || data.children.length === 0) {
                resultsContainer.innerHTML = `
                    <div style="padding: 20px; background-color: var(--card-color); border-radius: 4px; text-align: center;">
                        <p>No results found for "${currentQuery}"</p>
                        <p>Try different search terms or filters.</p>
                    </div>
                `;
                paginationContainer.innerHTML = '';
                return;
            }

            // Update pagination state
            currentAfter = data.after || null;
            currentBefore = data.before || null;

            // Display results
            data.children.forEach(item => {
                const post = item.data;

                // Display domain in url
                console.log({
                    title: post.title,
                    is_video: post.is_video,
                    domain: post.domain,
                    url: post.url
                });
            

                // Create result card
                const resultCard = document.createElement('div');
                resultCard.className = 'result-card';

                // Create comments section
                const commentsSection = document.createElement('div');
                commentsSection.className = 'comments-section';
                commentsSection.innerHTML = '<div class="loading-comments">Loading comments...</div>';
                resultCard.appendChild(commentsSection);

                // Fetch comments for this post
                fetchComments(post.permalink, commentsSection);

                // Vote section
                const voteSection = document.createElement('div');
                voteSection.className = 'vote-section';

                const upvoteBtn = document.createElement('button');
                upvoteBtn.className = 'vote-button';
                upvoteBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="18 15 12 9 6 15"></polyline>
                    </svg>
                `;

                const voteCount = document.createElement('div');
                voteCount.className = 'vote-count';
                voteCount.textContent = formatNumber(post.score);

                const downvoteBtn = document.createElement('button');
                downvoteBtn.className = 'vote-button';
                downvoteBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                `;

                voteSection.appendChild(upvoteBtn);
                voteSection.appendChild(voteCount);
                voteSection.appendChild(downvoteBtn);

                // Content section
                const contentSection = document.createElement('div');
                contentSection.className = 'content-section';

                // Result header with subreddit, author, time
                const resultHeader = document.createElement('div');
                resultHeader.className = 'result-header';

                const subredditLink = document.createElement('a');
                subredditLink.className = 'result-subreddit';
                subredditLink.href = `https://www.reddit.com/r/${post.subreddit}`;
                subredditLink.target = '_blank';

                // Subreddit icon
                const subredditIcon = document.createElement('div');
                subredditIcon.className = 'subreddit-icon';
                subredditIcon.textContent = post.subreddit.charAt(0).toUpperCase();

                subredditLink.appendChild(subredditIcon);
                subredditLink.appendChild(document.createTextNode('r/' + post.subreddit));

                const authorSpan = document.createElement('span');
                authorSpan.className = 'result-author';
                authorSpan.textContent = 'Posted by u/' + post.author;

                const timeSpan = document.createElement('span');
                timeSpan.className = 'result-time';
                timeSpan.textContent = formatTimestamp(post.created_utc);

                resultHeader.appendChild(subredditLink);
                resultHeader.appendChild(authorSpan);
                resultHeader.appendChild(timeSpan);

                // Result title
                const resultTitle = document.createElement('div');
                resultTitle.className = 'result-title';

                const titleLink = document.createElement('a');
                titleLink.href = `https://www.reddit.com${post.permalink}`;
                titleLink.target = '_blank';
                titleLink.textContent = post.title || 'Comment in thread';

                resultTitle.appendChild(titleLink);

                // Result content (text or snippet)
                const resultContent = document.createElement('div');
                resultContent.className = 'result-content';

                let snippet = '';
                if (post.selftext) {
                    snippet = post.selftext.length > 300
                        ? post.selftext.substring(0, 300) + '...'
                        : post.selftext;
                } else if (post.body) {
                    snippet = post.body.length > 300
                        ? post.body.substring(0, 300) + '...'
                        : post.body;
                }

                resultContent.textContent = snippet;

                // Result actions (comments, save, share)
                const resultActions = document.createElement('div');
                resultActions.className = 'result-actions';

                const commentsAction = document.createElement('div');
                commentsAction.className = 'result-action';
                commentsAction.innerHTML = `
                <svg class="action-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    ${post.num_comments || 0} Comments
                `;

                const saveAction = document.createElement('div');
                saveAction.className = 'result-action';
                saveAction.innerHTML = `
                    <svg class="action-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                    </svg>
                    Save
                `;

                const shareAction = document.createElement('div');
                shareAction.className = 'result-action';
                shareAction.innerHTML = `
                    <svg class="action-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="18" cy="5" r="3"></circle>
                        <circle cx="6" cy="12" r="3"></circle>
                        <circle cx="18" cy="19" r="3"></circle>
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                    </svg>
                    Share
                `;

                resultActions.appendChild(commentsAction);
                resultActions.appendChild(saveAction);
                resultActions.appendChild(shareAction);

                // Add all sections to content area
                contentSection.appendChild(resultHeader);
                contentSection.appendChild(resultTitle);

                if (snippet) {
                    contentSection.appendChild(resultContent);
                }

                contentSection.appendChild(resultActions);

                // Add main sections to card
                resultCard.appendChild(voteSection);
                resultCard.appendChild(contentSection);

                // Add thumbnail/preview image if available
                // Create container for image (always needed, even if empty)
                const imgContainer = document.createElement('div');
                imgContainer.className = 'img-container';
                imgContainer.style.width = '140px';
                imgContainer.style.height = '100px';

                // Add thumbnail/preview image if available
                if (
                    post.thumbnail &&
                    post.thumbnail !== 'self'  
                ) {
                    const imageLink = document.createElement('a');
                    imageLink.href = `https://www.reddit.com${post.permalink}`;
                    imageLink.target = '_blank';

                    const resultImage = document.createElement('img');
                    resultImage.src = post.thumbnail;
                    resultImage.alt = 'Post thumbnail';
                    resultImage.style.maxWidth = '140px';
                    resultImage.style.maxHeight = '100px';
                    resultImage.style.display = 'block';

                    imageLink.appendChild(resultImage);
                    imgContainer.appendChild(imageLink);
                } else {
                    // No image: make container invisible, but preserve layout
                    imgContainer.style.visibility = 'hidden';
                }

                // Test play icon
                // const playIcon = document.createElement('div');
                // playIcon.className = 'play-icon';
                // playIcon.innerHTML = '▶';
                // imgContainer.appendChild(playIcon);

                // Add play icon directly to the container if it's a video
                if (
                    post.is_video ||
                    (post.domain && post.domain.includes('youtu')) ||
                    (post.url && post.url.includes('v.redd.it')) ||
                    (post.domain && post.domain.includes('streamable')) ||
                    (post.url && post.url.endsWith('.gifv'))
                ) {
                    const playIcon = document.createElement('div');
                    playIcon.className = 'play-icon';
                    playIcon.innerHTML = '▶';

                    playIcon.style.position = 'absolute';
                    playIcon.style.top = '50%';
                    playIcon.style.left = '50%';
                    playIcon.style.transform = 'translate(-50%, -50%)';
                    playIcon.style.zIndex = '20';

                    imgContainer.appendChild(playIcon);
                }
            
                // Add container to result card
                resultCard.appendChild(imgContainer);
                resultsContainer.appendChild(resultCard);

                // Update pagination
                updatePagination();
                
            }); // 👈 close this loop
    }     // 👈 then close the function
            
        function updatePagination() {
            paginationContainer.innerHTML = '';

            if (currentBefore || currentAfter) {
                const prevButton = document.createElement('button');
                prevButton.className = 'pagination-button';
                prevButton.textContent = '← Previous';
                prevButton.disabled = !currentBefore;
                prevButton.addEventListener('click', () => {
                    if (currentBefore) {
                        performSearch(null, currentBefore);
                        window.scrollTo(0, 0);
                    }
                });

                const nextButton = document.createElement('button');
                nextButton.className = 'pagination-button';
                nextButton.textContent = 'Next →';
                nextButton.disabled = !currentAfter;
                nextButton.addEventListener('click', () => {
                    if (currentAfter) {
                        performSearch(currentAfter, null);
                        window.scrollTo(0, 0);
                    }
                });

                paginationContainer.appendChild(prevButton);
                paginationContainer.appendChild(nextButton);
            }
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp * 1000);
            const now = new Date();
            const diffSeconds = Math.floor((now - date) / 1000);

            if (diffSeconds < 60) {
                return `${diffSeconds} second${diffSeconds !== 1 ? 's' : ''} ago`;
            }

            const diffMinutes = Math.floor(diffSeconds / 60);
            if (diffMinutes < 60) {
                return `${diffMinutes} minute${diffMinutes !== 1 ? 's' : ''} ago`;
            }

            const diffHours = Math.floor(diffMinutes / 60);
            if (diffHours < 24) {
                return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
            }

            const diffDays = Math.floor(diffHours / 24);
            if (diffDays < 30) {
                return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
            }

            const diffMonths = Math.floor(diffDays / 30);
            if (diffMonths < 12) {
                return `${diffMonths} month${diffMonths !== 1 ? 's' : ''} ago`;
            }

            const diffYears = Math.floor(diffMonths / 12);
            return `${diffYears} year${diffYears !== 1 ? 's' : ''} ago`;
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'm';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'k';
            }
            return num.toString();
        }

        // Security function to prevent XSS
        function sanitizeHTML(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>

</html>