<!DOCTYPE html>
<html lang="en">

<body>
<head>
<script>
    try {
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
        }
    } catch (e) { }
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KarmaFinder - Better Reddit Search</title>
    <style>
  
        html {
            font-size: 90%;
            overflow-y: scroll;
        }

        :root {
            --primary-color: #ff4500;
            --secondary-color: #0079d3;
            --background-color: #f8f9fa;
            --card-color: #ffffff;
            --text-color: #1a1a1b;
            --light-text: #787c7e;
            --border-color: #edeff1;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            /*transition: all 0.15s ease-in-out;*/
            transition: none !important;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .link-container {
            display: inline-block;
            text-decoration: none;
            color: inherit;
            height: auto; /* Let it size to content */
            padding: 0;
            margin: 0;
            vertical-align: top; /* This prevents it from floating above */
            position: relative; /* Enable positioning */
            top: 0; /* Anchor to the top */
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 0; /* Remove all padding */
            position: relative; /* Enable positioning */
            line-height: 1; /* Tight line height */
        }

        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .tagline {
            font-size: 1.2rem;
            color: var(--light-text);
        }

        .image-wrapper {
            position: relative;
            width: 140px;
            height: 100px;
            border-radius: 6px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .image-placeholder {
            width: 100%;
            height: 100%;
            background-color: #f8f9fa;
            border-radius: 6px;
            position: absolute;
            top: 0;
            left: 0;
        }

        .shimmer::before {
            content: "";
            position: absolute;
            top: 0;
            left: -150px;
            height: 100%;
            width: 150px;
            background: linear-gradient(to right,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0.9) 50%,
                    /* almost pure white */
                    rgba(255, 255, 255, 0) 100%);
            animation: shimmer 1.25s infinite;
        }

        @keyframes shimmer {
            100% {
                transform: translateX(300%);
            }
        }

        .search-container {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
            background-color: var(--card-color);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.15s ease-in-out;
        }

        .search-input-container {
            display: flex;
            width: 80%;
            justify-content: center;
        }
        
        .search-top-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            width: fit-content;
            margin: 0 auto 16px auto;
            max-width: 1000px;     
            width: 100%;          
            margin: 0 auto 16px;  
        }

        .search-input {
            flex-grow: 1;
            padding: 12px 20px;
            font-size: 1.1rem;
            border: 1px solid var(--border-color);
            border-radius: 6px 0 0 6px;
            outline: none;
            background-color: #f8f9fa;
        }

        .search-input:focus {
            border-color: var(--secondary-color);
        }

        .search-button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            padding: 0 20px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .search-button:hover {
            background-color: #005fa3;
        }

        .advanced-options {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            transition: all 0.15s ease-in-out;
            justify-content: flex-start;
        }

        .option-group {
            flex: 0 0 auto;
            /* Don't grow or shrink, stay at natural width */
            min-width: 150px;
            /* Reduced minimum width */
            margin-right: 10px;
            /* Add some spacing between groups */
            transition: all 0.15s ease-in-out;
        }

        .option-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            transition: all 0.15s ease-in-out;
        }

        .option-group select,
        .option-group input {
            width: 180px;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            transition: all 0.15s ease-in-out;
        }

        #subreddit-input {
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem;
            transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out, border-color 0.15s ease-in-out;
        }

        #time-select {
            max-width: 165px;
        }

        #sort-select {
            max-width: 165px;
        }

        #safesearch-select {
            max-width: 165px;
        }

        .option-group {
  background-color: white;
  color: black;
}

.option-group select {
  background-color: white;
  color: black;
  transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out, border-color 0.15s ease-in-out;
}

        body.safe-search-enabled .nsfw img,
        body.safe-search-enabled .nsfw video,
        body.safe-search-enabled .nsfw .thumbnail {
            filter: blur(12px);
            pointer-events: none;
            transition: filter 0.2s ease;
        }

        .subreddit-dropdown {
            position: relative;
            background-color: #fff;
            transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out;
        }

        .subreddit-suggestions {
            position: absolute;
            background-color: var(--card-color, #fff);
            width: 100%;
            border: 1px solid #999;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            scrollbar-width: none;
            scrollbar-color: rgba(150, 150, 150, 0.6);
            transition: scrollbar-color 0.3s ease;
        }

        
        .subreddit-suggestions .custom-spinner-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px 0;
        }

        
        .subreddit-suggestions-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .subreddit-suggestions-container::-webkit-scrollbar {
            width: 4px;
        }

        .subreddit-suggestions-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .subreddit-suggestions-container::-webkit-scrollbar-thumb {
            background-color: transparent;
            border-radius: 4px;
        }

        
        .subreddit-suggestions-container:hover {
            scrollbar-color: rgba(150, 150, 150, 0.6);
            scrollbar-width: thin;
        }

        .subreddit-suggestions-container:hover::-webkit-scrollbar-thumb {
            background-color: rgba(150, 150, 150, 0.6);
        }

        .subreddit-suggestions-container:hover::-webkit-scrollbar-thumb:hover,
        .subreddit-suggestions-container:hover::-webkit-scrollbar-thumb:active {
            background-color: rgba(150, 150, 150, 0.6);
        }

        .subreddit-suggestions.active {
            display: block;
        }

        .subreddit-suggestion {
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .subreddit-suggestion:hover {
            background-color: var(--background-color);
        }

        .subreddit-suggestions::-webkit-scrollbar {
            width: 4px;
        }

        .subreddit-suggestions::-webkit-scrollbar-track {
            background: transparent;
        }

        .subreddit-suggestions::-webkit-scrollbar-thumb {
            background-color: transparent;
            border-radius: 4px;
        }

        .subreddit-suggestions:hover {
            scrollbar-color: rgba(180, 180, 180, 0.5) transparent;
            /* Firefox */
            scrollbar-width: thin;
            scrollbar-color: #444;
            background-color: white;
        }

        .subreddit-suggestions:hover::-webkit-scrollbar-thumb {
            background-color: transparent;
            /* WebKit */
        }

        .subreddit-suggestions:hover::-webkit-scrollbar-thumb:hover,
        .subreddit-suggestions:hover::-webkit-scrollbar-thumb:active {
            background-color: transparent;
            /* On interaction */
        }


        .subreddit-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .subreddit-icon img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .results-error {
            display: flex;
            position: relative;
            flex-direction: column;
            gap: 15px;
            border-radius: 8px;
            justify-content: center;
            align-items: center;
            min-height: 120px;
            transition: all 0.15s ease-in-out;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .results-container {
            display: flex;
            position: relative;
            flex-direction: column;
            gap: 3px;
            transition: opacity 0.3s ease;
        }

        .result-card {
            position: relative;
            margin-bottom: 15px;
            overflow: visible;
            display: flex;
            flex-direction: row;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            background-color: #fff;
            min-height: 130px;
            transition: all 0.15s ease-in-out;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            z-index: 1;
            /* Lower than dropdown */
        }

        .result-card:hover {
            box-shadow: 0 3px 4px rgba(0, 0, 0, 0.1);
        }

        /* COMFY MODE */
body.comfy-mode .result-card {
  padding: 18px;
  min-height: 270px;
  overflow: hidden; 
}

body.comfy-mode .img-container {
  height: 150px;
  width: 200px; 
  transition: all 0.15s ease-in-out;
}

body.comfy-mode .img-container img {
  height: 100%;
  max-height: 270px;
  max-width: 200px;
  object-fit: cover; 
  transition: all 0.15s ease-in-out;
}

body.comfy-mode .image-wrapper {
  height: 100%;
  width: 100%;
  transition: all 0.15s ease-in-out;
}

body.comfy-mode .result-image {
  height: 100%;
  width: 100%; 
  object-fit: cover; 
  max-width: 100%; 
  max-height: 100%; 
}

body.comfy-mode .result-card + .result-card {
  margin-top: 16px;
}

body.comfy-mode .content-section {
  line-height: 1.6;
  font-size: 1.05em;
}

        .vote-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 40px;
        }

        .vote-button {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--light-text);
            transition: color 0.2s;
        }

        .vote-button:hover {
            color: var(--secondary-color);
        }

        .vote-count {
            font-weight: bold;
            margin: 5px 0;
        }

        .content-section {
            flex-grow: 1;
            overflow: hidden;
            margin-left: 15px;
            color: #29213b;
            margin-right: 0;
        }

        .result-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
            font-size: 1rem;
            color: var(--light-text);
            color: #15121c;
            font-weight: 400;
            z-index: 0;
        }

        .result-subreddit {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            color: var(--text-color);
            text-decoration: none;
        }

        .result-subreddit:hover {
            text-decoration: underline;
        }

        .result-author,
        .result-time {
            margin-left: 5px;
        }

        .result-title {
            font-size: 1.2rem;
            margin-bottom: 8px;
            font-weight: 600;
            color: #15121c;
        }

        .result-title a {
            color: var(--text-color);
            text-decoration: none;
        }

        .result-title a:hover {
            color: var(--secondary-color);
        }

        .result-content {
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .result-actions {
            display: flex;
            gap: 15px;
            color: var(--light-text);
        }

        .result-action {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .result-action:hover {
            color: var(--text-color);
        }

        .error-card {
            padding: 20px;
            border-radius: 4px;
            background-color: var(--card-color);
            color: var(--text-color);
        }


        /* Comments section styles */
        .comments-section {
            width: 300px;
            font-size: small;
            flex-shrink: 0;
            max-height: 100px;
            overflow-y: hidden;
            background-color: #f9f9f9;
            border-radius: 6px;
            padding: 8px;
            margin-left: 15px;
            margin-right: 25px;
            transition: opacity 0.3s ease;
        }

        .comments-scroll {
            max-height: 100px;
            overflow-y: auto;
            padding: 8px;
            scrollbar-color: transparent transparent;
            scrollbar-width: thin;
            scrollbar-gutter: stable;
            transition: scrollbar-color 0.3s ease;
            box-sizing: border-box;
        }

        .comments-scroll:hover {
            scrollbar-color: rgba(180, 180, 180, 0.5) transparent;
        }

        .comments-section::-webkit-scrollbar {
            width: 4px;
        }

        .comments-section::-webkit-scrollbar-track {
            background: transparent;
        }

        .comments-section::-webkit-scrollbar-thumb {
            background-color: transparent;
            border-radius: 4px;
        }

        .comments-section:hover {
            scrollbar-color: rgba(180, 180, 180, 0.5) transparent;
            /* For Firefox */
        }

        .comments-section:hover::-webkit-scrollbar-thumb {
            background-color: rgba(180, 180, 180, 0.5);
            /* Light gray with transparency */
        }

        /* When scrollbar is actively being used */
        .comments-section:hover::-webkit-scrollbar-thumb:hover,
        .comments-section:hover::-webkit-scrollbar-thumb:active {
            background-color: rgba(160, 160, 160, 0.7);
            /* Darker when hovered/active */
        }

        .comment {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
            box-sizing: border-box;
        }

        .comment:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .comment-author {
            font-weight: bold;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
        }

        .comment-author-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: var(--light-text);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            margin-right: 5px;
        }

        .comment-text {
            line-height: 1.3;
            word-break: break-word;
        }

        .comment-meta {
            display: flex;
            font-size: 10px;
            color: var(--light-text);
            margin-top: 2px;
            box-sizing: border-box;
        }

        .comment-score {
            margin-right: 6px;
        }

        .comment-time {
            margin-left: auto;
        }

        .loading-comments {
            color: var(--light-text);

            width: 300px;
            max-width: 300px;
            font-size: small;
            flex-shrink: 0;
            max-height: 100px;
            height: 100px;
            overflow-y: hidden;
            background-color: #f9f9f9;
            border-radius: 6px;
            padding: 8px;
            margin-right: 5px;
            margin-top: 20px;
            transition: opacity 0.3s ease;
        }

        .see-more-comments {
            text-align: center;
            padding-top: 5px;
            font-size: 11px;
            color: var(--secondary-color);
            cursor: pointer;
            font-weight: bold;
            box-sizing: border-box;
        }

        .see-more-comments:hover {
            text-decoration: underline;
        }

        .action-icon {
            vertical-align: middle;
        }

        .result-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
            opacity: 0;
            transition: opacity 0.3s ease;
            display: block;
        }

        .result-image.show {
            opacity: 1;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--light-text);
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 10px;
        }

        .pagination-button {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        .pagination-button:hover:not(:disabled) {
            background-color: #f0f0f0;
        }

        .pagination-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .filter-chip-container {
            display: none;
            align-items: center;
            background-color: var(--background-color);
            border-radius: 16px;
            padding: 3px 10px;
            gap: 5px;
            margin-top: 5px;
        }

        .filter-chip-container .chip-text {
            font-size: 0.9rem;
        }

        .filter-chip-container .remove-chip {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: var(--light-text);
            color: white;
            font-size: 10px;
            line-height: 1;
        }

        footer {
            margin-top: 40px;
            text-align: center;
            padding: 20px;
            color: var(--light-text);
            font-size: 0.9rem;
        }

        .donate-btn {
            display: block;
            position: absolute;
            margin-top: 25px;
            right: 70px;
            background-color: var(--primary-color);
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: bold;
            transition: background-color 0.2s;
            z-index: 5;
        }

        .donate-btn:hover {
            background-color: #e03d00;
        }

        @media (max-width: 768px) {
            .advanced-options {
                flex-direction: column;
            }

            .result-card {
                display: flex;
                flex-direction: row;
                align-items: flex-start;
                padding: 15px;
                position: relative;
            }

            .vote-section {
                flex-shrink: 0;
                flex-direction: row;
                justify-content: center;
                gap: 10px;
            }
        }

        .img-container {
            margin-left: auto;
            position: relative;
            width: 140px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .img-container img {
            width: 100%;
            position: relative;
            border-radius: 4px;
            object-fit: cover;
        }

        .img-container .play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            padding-left: 4px;
            transform: translate(-48%, -50%);
            z-index: 10;
            pointer-events: none;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        #comfy-toggle {
  background: none;
  position: absolute;
  border: none;
  padding: 0;
  top: 14px;
  right: 35px;
  cursor: pointer;
  width: 105px;
  height: 40px;
}

#comfy-toggle img {
  width: 100%;
  height: auto;
  pointer-events: none;
  user-select: none;
  transition: filter 0.1s ease-in-out;
}

     #compact-toggle {
  background: none;
  position: absolute;
  border: none;
  padding: 0;
  top: 45px;
  right: 35px;
  cursor: pointer;
  width: 105px;
  height: 40px;
}

#compact-toggle img {
  width: 100%;
  height: auto;
  pointer-events: none;
  user-select: none;
  transition: filter 0.1s ease-in-out;
}

#filter-icon {
  position: absolute;
  top: 35px;   
  right: 152px; 
  width: 25px;
  height: 25px;
  pointer-events: none;
  user-select: none;
  filter: brightness(1.3);
  z-index: 10;
}

        .theme-toggle {
            position: fixed;
            top: 16px;
            left: 20px;
            right: unset;
            width: 50px;
            height: 50px;
            padding: 4px;
            background: transparent;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10000;
        }

        .theme-toggle img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: filter 0.3s ease;
        }

        /* Dark mode base */
        body.dark-mode {
            background-color: #141414;
            color: #f5f5f5;
            transition: all 0.15s ease-in-out;
        }
        body.dark-mode .option-group {
  background-color: #1e1e1e;
  color: white;
}

body.dark-mode .option-group select {
  background-color: #333;
  color: white;
  border-color: #444;
}

        /* Light-dark cards */
        body.dark-mode .result-card,
        body.dark-mode .search-box,
        body.dark-mode .search-controls,
        body.dark-mode .error-card,
        body.dark-mode .comment-box,
        body.dark-mode .search-container,
        body.dark-mode .option-group,
        body.dark-mode .subreddit-suggestion,
        body.dark-mode .subreddit-suggestions .custom-spinner-wrapper,
        body.dark-mode .subreddit-suggestions::-webkit-scrollbar,
        body.dark-mode .spinner-container {
            background-color: #222222;
            /* lighter dark grey */
            color: #ffffff;
            border-color: #333;
            /* optional border */
        }

        body.dark-mode .subreddit-dropdown {
            background-color: #222222;
        }


        body.dark-mode .comment {
            border-bottom: 1px solid #444;
        }

        body.dark-mode .result-card,
        body.dark-mode .result-title,
        body.dark-mode .result-title a,
        body.dark-mode .result-content,
        body.dark-mode .result-header,
        body.dark-mode .result-subreddit,
        body.dark-mode .result-actions,
        body.dark-mode .result-action {
            color: white;
        }

        body.dark-mode .search-input,
        body.dark-mode #subreddit-input {
            background-color: #1e1e1e;
            color: white;
            transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out, border-color 0.15s ease-in-out;
        }

        body.dark-mode .results-error {
            background-color: #222222;
        }

        body.dark-mode .results-container {
            background-color: #141414;
        }

        body.dark-mode .result-card:hover {
            box-shadow: 0 3px 5px #0e0e0e;
        }

        body.dark-mode .result-title a:hover {
            color: var(--secondary-color);
        }

        body.dark-mode .image-placeholder {
            background-color: #333;
        }

        body.dark-mode .pagination-button {
            background-color: #222222;
            border-color: #333;
            color: white;
        }

        body.dark-mode .shimmer::before {
            background: linear-gradient(to right,
                    transparent 0%,
                    rgba(255, 255, 255, 0.08) 50%,
                    transparent 100%);
        }

        /* Inputs and dropdowns */
        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode .filter-chip-container,
        body.dark-mode textarea {
            background-color: #333;
            color: #fff;
            border-color: #444;
        }

        body.dark-mode .loading-comments,
        body.dark-mode .comments-section {
            color: white;
            background-color: #333;
            border-color: #222;
        }

        body .dark-mode .vote-count {
            font-weight: bold;
            margin: 5px 0;
            color: white;
        }

        /* Scrollbar */
        body.dark-mode .subreddit-suggestions::-webkit-scrollbar-thumb {
            background-color: transparent;
        }

        body.dark-mode .subreddit-suggestion {
            scrollbar-width: none;
        }

        body.dark-mode .subreddit-suggestion:hover {
            scrollbar-color: #444;
            scrollbar-width: thin;
            background-color: #2a2a2a;
        }

        body.dark-mode .subreddit-suggestions-container {
            scrollbar-width: none;
            scrollbar-color: transparent transparent;
            /* For Firefox */
            background-color: #222222;
        }

        body.dark-mode .subreddit-suggestions:hover {
            scrollbar-width: thin;
            scrollbar-color: #444;
            background-color: #222222;
        }
    </style>
</head>

<body>

    <a href="donopage.html" class="donate-btn floating-button">Support the Site</a>
    <div class="container">
        <header
            style="display: flex; justify-content: center; align-items: center; position: relative; padding: 1rem 0;">
            <div style="text-align: center;">
            <a href="karmafinder.html" class="link-container">
                <div class="logo">KarmaFinder</div>
                </a>
                <div class="tagline">Find exactly what you're looking for on Reddit ðŸ”Ž</div>
            </div>
        </header>

        <button id="themeToggle" class="theme-toggle" aria-label="Toggle Dark Mode">
            <img id="themeIcon" src="moon.png" alt="Toggle theme" />
        </button>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const icon = document.getElementById('themeIcon');
                const isDark = document.documentElement.classList.contains('dark-mode');

                if (icon) {
                    icon.src = isDark ? 'sun.png' : 'moon.png';
                    icon.alt = isDark ? 'Switch to light mode' : 'Switch to dark mode';
                }
            });
        </script>

        <div class="search-container">
          <div class="search-top-row">
            <div class="search-input-container">
                <input type="text" id="search-input" class="search-input" placeholder="Search Reddit..." autofocus>
                <button id="search-button" class="search-button">Search</button>
                </div>
                <img src="iconny thingy.png" alt="filter icon" id="filter-icon" />
                <button id="comfy-toggle" aria-label="Toggle Comfy Mode">
                    <img src="comfy-default.png" alt="Toggle comfy layout" />
                </button>
                <button id="compact-toggle" aria-label="Toggle Compact Mode">
                    <img src="compact-default.png" alt="Toggle compact layout" />
                </button>
            </div>

            <div class="advanced-options">
                <div class="option-group">
                    <label for="sort-select">Sort By</label>
                    <select id="sort-select">
                        <option value="hot">Hot</option>
                        <option value="top">Top</option>
                        <option value="relevance">Relevance</option>
                        <option value="new">New</option>
                    </select>
                </div>

                <div class="option-group">
                    <label for="time-select">Time Period</label>
                    <select id="time-select">
                        <option value="all">All Time</option>
                        <option value="year">Past Year</option>
                        <option value="month">Past Month</option>
                        <option value="week">Past Week</option>
                        <option value="day">Past 24 Hours</option>
                        <option value="hour">Past Hour</option>
                    </select>

                </div>

                <div class="option-group">
                    <label for="safesearch-select">SafeSearch</label>
                    <select id="safesearch-select">
                        <option value="on">On</option>
                        <option value="off">Off</option>
                    </select>
                </div>

                <div class="option-group subreddit-dropdown">
                    <label for="subreddit-input">Subreddit (optional)</label>
                    <input type="text" id="subreddit-input" placeholder="e.g., AskReddit">
                    <div id="subreddit-suggestions-container">
                        <div id="subreddit-suggestions" class="subreddit-suggestions"></div>
                    </div>
                    <div class="filter-chip-container" id="subreddit-chip-container">
                        <span class="chip-text"></span>
                        <span class="remove-chip">Ã—</span>
                    </div>
                </div>

                <div class="option-group">
                    <label for="content-select">Content Type</label>
                    <select id="content-select">
                        <option value="all">All Content</option>
                        <option value="posts">Posts Only</option>
                        <option value="comments">Comments Only</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="results" class="results-container">
            <!-- Results will be populated here -->
        </div>

        <div id="pagination" class="pagination">
            <!-- Pagination will be added here -->
        </div>

        <footer>
            <p>KarmaFinder helps you search Reddit content more effectively than Reddit's native search.</p>
            <p>If you find this tool useful, please consider supporting its development. KarmaFinder is an independent
                search utility and is not affiliated with Reddit Inc.</p>
            <a href="#" id="button">Github // Discord</a>
        </footer>
    </div>

    <script>
        // Seven minutes. Seven minutes is all I can spare to play with you.
        const CACHE_DURATION_MS = 7 * 60 * 1000;

        // Configuration 
        const API_ENDPOINT = 'http://localhost:3000/reddit';

        const RESULTS_PER_PAGE = 10;

        let searchTimeout = null;

        let POPULAR_SUBREDDITS = [
            { name: 'AskReddit', icon: '/api/placeholder/20/20' },
            { name: 'funny', icon: '/api/placeholder/20/20' },
            { name: 'gaming', icon: '/api/placeholder/20/20' }
            // These are just fallbacks in case the API request fails
        ];

        // Add this function to fetch popular subreddits
        function fetchPopularSubreddits() {
            console.log("Attempting to fetch popular subreddits...");

            // Start with an empty array - we'll populate it completely from the API
            fetch('http://localhost:3000/reddit?url=https://www.reddit.com/subreddits/popular.json?limit=100')
                .then(response => {
                    if (!response.ok) throw new Error('Failed to fetch popular subreddits');
                    return response.json();
                })
                .then(data => {
                    if (data && data.data && data.data.children) {
                        POPULAR_SUBREDDITS = data.data.children.map(child => ({
                            name: child.data.display_name,
                            icon: child.data.icon_img || '/api/placeholder/20/20'
                        }));
                        console.log('Loaded popular subreddits:', POPULAR_SUBREDDITS.length);

                        // Keep some fallbacks only if the API returned nothing
                        if (POPULAR_SUBREDDITS.length === 0) {
                            POPULAR_SUBREDDITS = [
                                { name: 'AskReddit', icon: '/api/placeholder/20/20' },
                                { name: 'funny', icon: '/api/placeholder/20/20' },
                                { name: 'gaming', icon: '/api/placeholder/20/20' }
                            ];
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching popular subreddits:', error);
                });
        }

        // Call this function when the page loads
        document.addEventListener('DOMContentLoaded', fetchPopularSubreddits);

        // DOM Elements
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const sortSelect = document.getElementById('sort-select');
        const timeSelect = document.getElementById('time-select');
        const subredditInput = document.getElementById('subreddit-input');
        const contentSelect = document.getElementById('content-select');
        const resultsContainer = document.getElementById('results');
        const paginationContainer = document.getElementById('pagination');
        const subredditSuggestions = document.getElementById('subreddit-suggestions');
        const subredditChipContainer = document.getElementById('subreddit-chip-container');
        const dropdown = document.getElementById('subreddit-suggestions');

        // State
        let navigationHistory = [];
        let currentPageIndex = 0;
        let currentQuery = '';
        let currentAfter = null;
        let currentBefore = null;
        let isLoading = false;
        let currentFilters = {
            sort: 'relevance',
            time: 'all',
            subreddit: '',
            contentType: 'all'
        };

        // Event Listeners
        searchButton.addEventListener('click', () => {
            currentPageIndex = 0;
            navigationHistory = [];
            performSearch();
        });

        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                currentPageIndex = 0;
                navigationHistory = [];
                performSearch();
            }
        });

        sortSelect.addEventListener('change', () => {
            currentFilters.sort = sortSelect.value;
            performSearch();
        });

        timeSelect.addEventListener('change', () => {
            currentFilters.time = timeSelect.value;
            performSearch();
        });

        document.getElementById('safesearch-select').addEventListener('change', function () {
            const enabled = this.value === 'on';
            document.body.classList.toggle('safe-search-enabled', enabled);
            console.log(`SafeSearch is now ${enabled ? 'ON' : 'OFF'}`);
        });

        contentSelect.addEventListener('change', () => {
            currentFilters.contentType = contentSelect.value;
            performSearch();
        });

        const comfyToggle = document.getElementById('comfy-toggle');
        const compactToggle = document.getElementById('compact-toggle');

        let isComfyActive = false;
        let isCompactActive = true;

        comfyToggle.querySelector('img').src = 'comfy-default.png';
        compactToggle.querySelector('img').src = 'compact-default.png';

            comfyToggle.addEventListener('click', () => {
                    if (isComfyActive) {
                        if (hasClickedOnce && !isCompactActive) return; // prevent both off
                        isComfyActive = false;
                        comfyToggle.querySelector('img').src = 'comfy-default.png';
                    } else {
                        isComfyActive = true;
                        comfyToggle.querySelector('img').src = 'comfy-pressed.png';

                        isCompactActive = false;
                        compactToggle.querySelector('img').src = 'compact-default.png';
                    }

                    hasClickedOnce = true;
                
                    if (isComfyActive) {
                    document.body.classList.add('comfy-mode');
                } else {
                    document.body.classList.remove('comfy-mode');
                }

                });


           compactToggle.addEventListener('click', () => {
                if (isCompactActive) {
                    if (hasClickedOnce && !isComfyActive) return; // prevent both off
                    isCompactActive = false;
                    compactToggle.querySelector('img').src = 'compact-default.png';
                } else {
                    isCompactActive = true;
                    compactToggle.querySelector('img').src = 'compact-pressed.png';
                    document.body.classList.remove('comfy-mode');

                    isComfyActive = false;
                    comfyToggle.querySelector('img').src = 'comfy-default.png';
                }

                hasClickedOnce = true;
            });


        // Remove subreddit filter when clicking X
        subredditChipContainer.querySelector('.remove-chip').addEventListener('click', () => {
            currentFilters.subreddit = '';
            subredditChipContainer.style.display = 'none';
        });

        // Handle suggestion selection
        subredditSuggestions.addEventListener('click', (e) => {
            const suggestion = e.target.closest('.subreddit-suggestion');
            if (suggestion) {
                const subName = suggestion.getAttribute('data-name');
                selectSubreddit(subName);
            }
        });

        // Handle typing in subreddit input
        subredditInput.addEventListener('input', () => {
            const query = subredditInput.value.toLowerCase().trim();

            // Show dropdown immediately with a loading spinner
            if (query.length > 0) {
                if (!subredditSuggestions.querySelector('.custom-spinner-wrapper')) {
                    subredditSuggestions.innerHTML = '';
                    subredditSuggestions.appendChild(createCanvasSpinner());
                }

                subredditSuggestions.classList.add('active');
            } else {
                subredditSuggestions.classList.remove('active');
            }

            // Debounce Reddit API call
            if (searchTimeout) clearTimeout(searchTimeout);

            searchTimeout = setTimeout(() => {
                handleSubredditSuggestions(query);
            }, 200); // delay debounce here
        });

        // Cubic-bezier easing 
        function cubicBezier(p0, p1, p2, p3) {
            return function (t) {
                const cx = 3 * (p1 - p0);
                const bx = 3 * (p2 - p1) - cx;
                const ax = 1 - cx - bx;

                const cy = 3 * (p1 - p0);
                const by = 3 * (p2 - p1) - cy;
                const ay = 1 - cy - by;

                let x = t, t2 = t;
                for (let i = 0; i < 5; i++) {
                    const f = ax * t2 * t2 * t2 + bx * t2 * t2 + cx * t2 - x;
                    const df = 3 * ax * t2 * t2 + 2 * bx * t2 + cx;
                    t2 = t2 - f / df;
                    t2 = Math.max(0, Math.min(t2, 1));
                }

                return ay * t2 * t2 * t2 + by * t2 * t2 + cy * t2;
            };
        }

        // Begin animation
        function startSpinnerAnimation(ctx) {
            const easeCustom = cubicBezier(0.1, 0.83, 0.37, 1);
            const cycleDuration = 700;
            let startTime = null;

            function animate(timestamp) {
                if (!startTime) startTime = timestamp;

                const elapsed = timestamp - startTime;
                const t = (elapsed % cycleDuration) / cycleDuration;
                const ramp = Math.pow(t, 0.8);
                const eased = easeCustom(ramp);

                const angle = (eased * 6.28 + 7.8) % 6.28;
                const shrinkEase = easeCustom(t);
                const sinePhase = Math.sin(shrinkEase * Math.PI);
                const shrinkPhase = easeCustom(sinePhase);
                const shrink = 0.5 + 0.5 * shrinkPhase;
                const arcLength = Math.PI * 0.7 * shrink;

                ctx.clearRect(0, 0, 50, 50);
                ctx.beginPath();
                const arcStart = angle - arcLength;
                ctx.arc(25, 25, 18, arcStart, angle);
                ctx.strokeStyle = "#C1C0C1";
                ctx.lineWidth = 4;
                ctx.stroke();

                requestAnimationFrame(animate);
            }

            requestAnimationFrame(animate);
        }

        // SPINNY
        function createCanvasSpinner() {
            const wrapper = document.createElement('div');
            wrapper.className = 'custom-spinner-wrapper';

            const canvas = document.createElement('canvas');
            canvas.width = 50;
            canvas.height = 50;
            canvas.id = 'main-spinner-placeholder';
            wrapper.appendChild(canvas);

            const ctx = canvas.getContext('2d');
            startSpinnerAnimation(ctx); 

            return wrapper;
        }

        // Combine popular and other search results to same timing
        async function handleSubredditSuggestions(query) {
            const localMatches = POPULAR_SUBREDDITS.filter(sub =>
                sub.name.toLowerCase().startsWith(query)
            );

            let remoteMatches = [];

            try {
                const res = await fetch(`http://localhost:3000/reddit?url=https://www.reddit.com/subreddits/search.json?q=${encodeURIComponent(query)}`);
                const data = await res.json();

                if (data?.data?.children?.length > 0) {
                    remoteMatches = data.data.children
                        .filter(child => child.data.display_name.toLowerCase().startsWith(query))
                        .map(child => ({
                            name: child.data.display_name,
                            icon: child.data.icon_img || '/api/placeholder/20/20'
                        }));
                }
            } catch (err) {
                console.error("Subreddit fetch failed:", err);
            }

            const merged = [...localMatches, ...remoteMatches].filter(
                (sub, index, self) =>
                    index === self.findIndex(s => s.name === sub.name)
            );

            subredditSuggestions.innerHTML = ''; // clear spinner

            if (merged.length === 0) {
                subredditSuggestions.innerHTML = '<div class="no-results">No subreddits found</div>';
                return;
            }

            populateSubredditSuggestions(merged);

        }

        function fetchSubredditSuggestions(query) {
            console.log("Searching for subreddits containing:", query);

            // Use Reddit's API to search for subreddits matching the query
            fetch(`http://localhost:3000/reddit?url=https://www.reddit.com/subreddits/search.json?q=${encodeURIComponent(query)}`)
                .then(response => {
                    if (!response.ok) throw new Error('Failed to search subreddits');
                    return response.json();
                })
                .then(data => {
                    if (data && data.data && data.data.children && data.data.children.length > 0) {
                        // Only keep subreddits that start with the query
                        const searchResults = data.data.children
                            .filter(child => child.data.display_name.toLowerCase().startsWith(query.toLowerCase()))
                            .map(child => ({
                                name: child.data.display_name,
                                icon: child.data.icon_img || '/api/placeholder/20/20'
                            }));

                        console.log('Filtered search results:', searchResults);

                        // Get current suggestion names to avoid duplicates
                        const currentSuggestions = Array.from(subredditSuggestions.children)
                            .map(el => el.getAttribute('data-name'));

                        const newSuggestions = searchResults.filter(sub =>
                            !currentSuggestions.includes(sub.name)
                        );

                        if (newSuggestions.length > 0) {
                            appendSubredditSuggestions(newSuggestions);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error searching subreddits:', error);

                    // For fallback, also be more strict
                    setTimeout(() => {
                        const simulatedResults = [
                            { name: query + 'Pics', icon: '/api/placeholder/20/20' },
                            { name: query + 'Memes', icon: '/api/placeholder/20/20' },
                            { name: query + 'Pro', icon: '/api/placeholder/20/20' }
                        ];

                        const currentSuggestions = Array.from(subredditSuggestions.children)
                            .map(el => el.getAttribute('data-name'));

                        const newSuggestions = simulatedResults.filter(sub =>
                            !currentSuggestions.includes(sub.name)
                        );

                        if (newSuggestions.length > 0) {
                            appendSubredditSuggestions(newSuggestions);
                        }
                    }, 300);
                });
        }

        function populateSubredditSuggestions(subreddits) {
            console.log("Populating subreddit suggestions:", subreddits);

            // Clear the suggestions container first
            subredditSuggestions.innerHTML = '';

            // Sort subreddits by relevance to the search query
            const query = subredditInput.value.toLowerCase().trim();
            if (query.length > 0) {
                subreddits.sort((a, b) => {
                    const aName = a.name.toLowerCase();
                    const bName = b.name.toLowerCase();

                    // Exact matches first
                    if (aName === query && bName !== query) return -1;
                    if (bName === query && aName !== query) return 1;

                    // Then starts with matches
                    if (aName.startsWith(query) && !bName.startsWith(query)) return -1;
                    if (bName.startsWith(query) && !aName.startsWith(query)) return 1;

                    // Then contains matches (already handled by filtering)
                    // Finally alphabetical
                    return aName.localeCompare(bName);
                });
            }

            // If there are results from filtering, add them
            if (subreddits.length > 0) {
                subreddits.forEach(sub => {
                    const suggestion = document.createElement('div');
                    suggestion.className = 'subreddit-suggestion';
                    suggestion.setAttribute('data-name', sub.name);

                    const iconEl = document.createElement('div');
                    iconEl.className = 'subreddit-icon';

                    if (sub.icon && sub.icon !== '/api/placeholder/20/20') {
                        const img = document.createElement('img');
                        img.src = sub.icon;
                        img.alt = sub.name;
                        iconEl.appendChild(img);
                    } else {
                        iconEl.textContent = sub.name.charAt(0).toUpperCase();
                    }

                    suggestion.appendChild(iconEl);
                    suggestion.appendChild(document.createTextNode(sub.name));

                    subredditSuggestions.appendChild(suggestion);
                });
            }

            // Add an attribute to track if we have results
            subredditSuggestions.setAttribute('data-has-results', subreddits.length > 0 ? 'true' : 'false');
        }

        function appendSubredditSuggestions(subreddits) {
            // First, check if we already have results
            const hasResults = subredditSuggestions.getAttribute('data-has-results') === 'true';

            // If we have new suggestions and no existing ones, remove any "no results" message
            if (subreddits.length > 0 && !hasResults) {
                subredditSuggestions.innerHTML = '';
                subredditSuggestions.setAttribute('data-has-results', 'true');
            }

            subreddits.forEach(sub => {
                const suggestion = document.createElement('div');
                suggestion.className = 'subreddit-suggestion';
                suggestion.setAttribute('data-name', sub.name);

                const iconEl = document.createElement('div');
                iconEl.className = 'subreddit-icon';

                if (sub.icon && sub.icon !== '/api/placeholder/20/20') {
                    const img = document.createElement('img');
                    img.src = sub.icon;
                    img.alt = sub.name;
                    iconEl.appendChild(img);
                } else {
                    iconEl.textContent = sub.name.charAt(0).toUpperCase();
                }

                suggestion.appendChild(iconEl);
                suggestion.appendChild(document.createTextNode(sub.name));

                subredditSuggestions.appendChild(suggestion);
            });
        }

        function selectSubreddit(subName) {
            currentFilters.subreddit = subName;
            subredditChipContainer.style.display = 'flex';
            subredditChipContainer.querySelector('.chip-text').textContent = 'r/' + subName;
            subredditInput.value = '';
            subredditSuggestions.classList.remove('active');
        }

        // Error handler
        function showError(err) {
            console.error('ðŸš¨ Error fetching Reddit data:', err);
            const resultsContainer = document.getElementById('results');
            resultsContainer.innerHTML = `
        <div class="error-box">
            <strong>Error:</strong> ${err.message || 'Unknown error occurred.'}
        </div>
    `;
        }

        function tryUseCachedResults(cacheKey, navigateBack = false) {
                const cachedItem = localStorage.getItem(cacheKey);

                if (!cachedItem) return false;

                try {
                    const cachedData = JSON.parse(cachedItem);
                    const isFresh = Date.now() - cachedData.timestamp < CACHE_DURATION_MS;

                    // If it's a pagination/backload, we want to allow expired cache too
                    const allowStale = navigateBack;

                    if (isFresh || allowStale) {
                        // Refresh the tokens here
                        currentAfter = cachedData.after || null;  // Update currentAfter with the cached value
                        currentBefore = cachedData.before || null;  // Update currentBefore with the cached value

                           // âœ… Store page in navigation history
                        navigationHistory[currentPageIndex] = {
                            query: currentFilters.query,
                            after: currentAfter,
                            before: currentBefore,
                            nextAfter: cachedData.after || null,
                            nextBefore: cachedData.before || null,
                            results: cachedData.data
                        };

                        // Display the results from cache
                        displayResults(cachedData.data);
                        window.scrollTo(0, 0);
                        updatePagination();

                        console.log(`ðŸ”¥ DEBUG (cache hit):`, {
                            context: navigateBack ? 'navigateBack' : 'regular',
                            cacheKey,
                            cachedAfter: cachedData.after,
                            cachedBefore: cachedData.before,
                            cachedData: cachedData.data
                        });

                        return true; // âœ… used cache
                    } else {
                        localStorage.removeItem(cacheKey);
                    }
                } catch (e) {
                    localStorage.removeItem(cacheKey);
                }

                return false; // âŒ cache miss or invalid
            }

        // Modified performSearch function with caching
        function performSearch(after = null, before = null, navigateBack = false, isInitialLoad = false) {
        let cacheKey = '';
            console.log('ðŸŸ¢ performSearch() called with:', { after, before, navigateBack, isInitialLoad });
            console.log('ðŸ” Current Index:', currentPageIndex, 'navigateBack:', navigateBack);

        // Setting filters before cache
        const query = searchInput.value.trim();
        const subredditTyped = document.getElementById('subreddit-input').value.trim();
        const chipVisible = subredditChipContainer.style.display === 'flex';
        const hasSubreddit = chipVisible || subredditTyped;

        // Update filters from UI
        currentFilters.query = query;
        currentFilters.time = document.getElementById('time-select').value;
        currentFilters.sort = document.getElementById('sort-select').value;
        currentFilters.contentType = document.getElementById('content-select').value;

        // Get subreddit from chip container if visible, otherwise from input
        if (subredditChipContainer.style.display === 'flex') {
            // Get the subreddit from the chip text (removing the 'r/' prefix)
            const chipText = subredditChipContainer.querySelector('.chip-text').textContent;
            currentFilters.subreddit = chipText.replace('r/', '');
        } else {
            // Fallback to input value
            currentFilters.subreddit = document.getElementById('subreddit-input').value.trim() || 'all';
        }

             // ðŸ”‘ Generate the cache key using current filters and tokens
            cacheKey = `kf_search_${currentFilters.query || ''}_${currentFilters.sort || 'hot'}_${currentFilters.time || 'all'}_${currentFilters.subreddit || ''}_${currentFilters.contentType || 'all'}`;

            if (tryUseCachedResults(cacheKey)) {
                console.log('âœ… Loaded from cache successfully:', cacheKey);
                return;
            }

            if (navigateBack) {
                const targetPage = navigationHistory[currentPageIndex];

                if (targetPage?.results?.length) {
                    currentFilters.query = targetPage.query;

                    // ðŸ›  Restore tokens too
                    currentAfter = targetPage.after || null;
                    currentBefore = targetPage.before || null;

                    console.log("â¬…ï¸ Navigating back to page:", currentPageIndex);
                    displayResults(targetPage.results);
                    updatePagination();
                    window.scrollTo(0, 0);
                    return;
                }

                console.warn("âš ï¸ No cached results for previous page.");
                return;
            }

            // Begin constructing URL
            const encodedQuery = encodeURIComponent(query);
            let sort = currentFilters.sort;
            const time = currentFilters.time;
            const subreddit = currentFilters.subreddit;
            const limit = 10;

            // If there's no query, and user chose 'relevance', fallback to 'hot'
            const isQuerying = query.length > 0;
            if (!isQuerying && sort === 'relevance') {
                sort = 'hot';
            }

            if (isQuerying) {
                finalUrl = `https://www.reddit.com${subreddit ? `/r/${subreddit}` : ''}/search.json?q=${encodedQuery}&sort=${sort}&restrict_sr=1&limit=${limit}&t=${time}`;
            } else if (subreddit) {
                finalUrl = `https://www.reddit.com/r/${subreddit}/${sort}.json?limit=${limit}&t=${time}`;
            } else {
                finalUrl = `https://www.reddit.com/r/all/${sort}.json?limit=${limit}&t=${time}`;
            }

            if (after) finalUrl += `&after=${after}`;
            if (before) finalUrl += `&before=${before}`;

            console.log('ðŸ” Filters applied:', currentFilters);
            console.log('ðŸ”— Final Reddit API URL:', finalUrl);

            // Proxy fetch
            fetch(`http://localhost:3000/reddit?url=${encodeURIComponent(finalUrl)}`)
                .then(res => {
                    if (!res.ok) {
                        throw new Error('Failed to fetch results from Reddit');
                    }
                    return res.json();
                })
                
                .then(data => {
                    // Store the new tokens from Reddit's response     

                    currentAfter = data.data?.after || null;
                    currentBefore = data.data?.before || null;

                    console.log("ðŸ” After setting, currentAfter is:", currentAfter);

                    const trimmedData = data.data.children.map(post => ({
                        title: post.data.title,
                        url: post.data.url,
                        permalink: post.data.permalink,
                        subreddit: post.data.subreddit,
                        score: post.data.score,
                        is_video: post.data.is_video,
                        domain: post.data.domain,
                        author: post.data.author,
                        created_utc: post.data.created_utc,
                        num_comments: post.data.num_comments,
                        over_18: post.data.over_18,
                        preview: post.data.preview,
                        selftext: post.data.selftext,
                        body: post.data.body
                    }));

                    // Store the page state in navigationHistory for future pages
                    navigationHistory[currentPageIndex] = {
                        query: currentFilters.query,
                        after: currentAfter,
                        before: currentBefore,
                        nextAfter: data.data?.after || null,  
                        nextBefore: data.data?.before || null, 
                        results: trimmedData
                    };

                    console.log('Data from API for ' + currentFilters.sort + ' sorting:', trimmedData);

                    // ðŸ’¾ Store in localStorage cache
                    if (trimmedData.length > 0) {
                        const cacheData = {
                            timestamp: Date.now(),
                            data: trimmedData,
                            after: currentAfter,
                            before: currentBefore   
                        };
                        localStorage.setItem(cacheKey, JSON.stringify(cacheData));
                        console.log('ðŸ’¾ Cached new results for:', cacheKey);
                    } else {
                        console.warn('âš ï¸ Not caching empty results for:', cacheKey);
                    }

                    if (!navigateBack) {
                        // ðŸ§¼ Clean up forward history if user had previously gone back
                        navigationHistory.length = currentPageIndex + 1;

                        // ðŸ’¾ Try to load from localStorage or memory cache
                        if (tryUseCachedResults(cacheKey)) {
                            console.log("âœ… Loaded results from cache for", cacheKey);
                            return;
                        }

                        // ðŸ§  Only run this if cache MISS
                        showLoading();

                        // Store the current page's state
                        navigationHistory[currentPageIndex] = {
                            query: currentFilters.query,
                            after: currentAfter,
                            before: currentBefore,
                            nextAfter: data.data?.after || null,
                            nextBefore: data.data?.before || null, 
                            results: trimmedData                   
                        };

                        console.log("ðŸ”¥ Debug:", {
                            currentPageIndex,
                            navigateBack,
                            afterParam: after,
                            beforeParam: before,
                            receivedAfterFromReddit: data.data?.after || null,
                            receivedBeforeFromReddit: data.data?.before || null,
                            currentAfter,
                            currentBefore,
                            navigationHistorySlot: navigationHistory[currentPageIndex],
                            fullHistory: [...navigationHistory]
                        });  
                    }
                    // Display the results

                    const now = Math.floor(Date.now() / 1000);
                    let timeCutoff = 0;

                    switch (currentFilters.time) {
                        case "hour":
                            timeCutoff = now - (60 * 60); // 1 hour
                            break;
                        case "day":
                            timeCutoff = now - (24 * 60 * 60); // 1 day
                            break;
                        case "week":
                            timeCutoff = now - (7 * 24 * 60 * 60); // 1 week
                            break;
                        case "month":
                            timeCutoff = now - (30 * 24 * 60 * 60); // ~1 month
                            break;
                        case "year":
                            timeCutoff = now - (365 * 24 * 60 * 60); // ~1 year
                            break;
                        case "all":
                        default:
                            timeCutoff = 0; // No cutoff, show everything
                            break;
                    }

                    const filteredData = trimmedData.filter(post => {
        
                        return post.created_utc && post.created_utc >= timeCutoff;
                    });

                    displayResults(filteredData);
                    window.scrollTo(0, 0);
                    updatePagination();
                })
                .catch(err => showError(err));
        }
    
        // Add cache management utility function
        function clearExpiredCaches() {
            const now = Date.now();
            const cachePrefix = 'kf_search_';

            // Loop through all localStorage items
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);

                // Only process our cache keys
                if (key && key.startsWith(cachePrefix)) {
                    try {
                        const cachedData = JSON.parse(localStorage.getItem(key));

                        // Remove if expired
                        if (now - cachedData.timestamp >= CACHE_DURATION_MS) {
                            localStorage.removeItem(key);
                            console.log('ðŸ§¹ Removed expired cache:', key);
                        }
                    } catch (e) {
                        // If we can't parse it, remove it
                        localStorage.removeItem(key);
                    }
                }
            }
        }

        function showLoading() {
            isLoading = true;
            resultsContainer.innerHTML = ''; // Clear previous content

            const spinnerWrapper = createCanvasSpinner();
            resultsContainer.appendChild(spinnerWrapper);

            paginationContainer.innerHTML = '';
        }

        // Function to fetch comments for a post
        function fetchComments(permalink, commentsContainer) {

                // Otherwise, fetch from Reddit via your proxy
                const commentsUrl = `http://localhost:3000/reddit?url=https://www.reddit.com${permalink}.json`;

                fetch(commentsUrl)
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to fetch comments');
                        return response.json();
                    })
                    .then(data => {
                        renderComments(data, commentsContainer, permalink);
                    })
                    .catch(error => {
                        console.error('Error fetching comments:', error);
                        commentsContainer.innerHTML = '<div class="loading-comments">No comments found</div>';
                    });
            }

        function renderComments(data, commentsContainer, permalink) {
                const commentsData = data[1].data.children;

                if (commentsData.length === 0) {
                    commentsContainer.innerHTML = '<div class="loading-comments">No comments found</div>';
                    return;
                }

                // Sort comments by score (highest first)
                commentsData.sort((a, b) => (b.data.score || 0) - (a.data.score || 0));
                commentsContainer.innerHTML = '';

                const topComments = commentsData.slice(0, 5);
                topComments.forEach(comment => {
                    if (comment.kind !== 't1') return;
                    const c = comment.data;

                    const commentEl = document.createElement('div');
                    commentEl.className = 'comment';

                    const authorEl = document.createElement('div');
                    authorEl.className = 'comment-author';
                    const authorIconEl = document.createElement('div');
                    authorIconEl.className = 'comment-author-icon';
                    authorIconEl.textContent = c.author.charAt(0).toUpperCase();
                    authorEl.appendChild(authorIconEl);
                    authorEl.appendChild(document.createTextNode(c.author));

                    const textEl = document.createElement('div');
                    textEl.className = 'comment-text';
                    const sanitizedBody = sanitizeHTML(c.body);
                    textEl.textContent = sanitizedBody.length > 150 ? sanitizedBody.slice(0, 150) + '...' : sanitizedBody;

                    const metaEl = document.createElement('div');
                    metaEl.className = 'comment-meta';
                    const scoreEl = document.createElement('span');
                    scoreEl.className = 'comment-score';
                    scoreEl.textContent = formatNumber(c.score) + ' points';
                    const timeEl = document.createElement('span');
                    timeEl.className = 'comment-time';
                    timeEl.textContent = formatTimestamp(c.created_utc);
                    metaEl.appendChild(scoreEl);
                    metaEl.appendChild(timeEl);

                    commentEl.appendChild(authorEl);
                    commentEl.appendChild(textEl);
                    commentEl.appendChild(metaEl);
                    commentsContainer.appendChild(commentEl);
                });

                if (commentsData.length > 5) {
                    const seeMoreEl = document.createElement('div');
                    seeMoreEl.className = 'see-more-comments';
                    seeMoreEl.textContent = `See all ${commentsData.length} comments`;
                    seeMoreEl.addEventListener('click', () => {
                        window.open(`https://www.reddit.com${permalink}`, '_blank');
                    });
                    commentsContainer.appendChild(seeMoreEl);
                }
            }

        function displayResults(data) {
            resultsContainer.style.opacity = 0;
                resultsContainer.innerHTML = '';

                // Check if we're dealing with cached data (an array) or API response
                const isFromCache = Array.isArray(data);

                const posts = isFromCache
                    ? data  // cached data is already processed
                    : data.data?.children.map(item => item.data) || [];

                // Update pagination tokens based on data source
                if (isFromCache) {

                    const cacheKey = `kf_search_${currentFilters.query || ''}_${currentFilters.sort || 'hot'}_${currentFilters.time || 'all'}_${currentFilters.subreddit || ''}_${currentFilters.contentType || 'all'}_${currentAfter || ''}_${currentBefore || ''}`;

                    // For cached data, we need to load the tokens from cache too

                    const cachedItem = localStorage.getItem(cacheKey);

                    if (cachedItem) {
                        try {
                            const cachedData = JSON.parse(cachedItem);
                            currentAfter = cachedData.after;
                            currentBefore = cachedData.before;
                            console.log("ðŸ”„ Loaded pagination tokens from cache:", { currentAfter, currentBefore });
                        } catch (e) {
                            console.error("Error loading pagination tokens from cache:", e);
                        }
                    }
                } else {
                    // For fresh API data, use the tokens from the response
                    currentAfter = data.data?.after || null;
                    currentBefore = data.data?.before || null;
                    console.log("ðŸ”„ Updated pagination tokens from API:", { currentAfter, currentBefore });
                }

            if (posts.length === 0) {
                resultsContainer.innerHTML = `
            <div class='results-error'>
                <p>No results found for "${currentFilters.query}". Try different search terms or filters</p>
            </div>
        `;
                paginationContainer.innerHTML = '';
                resultsContainer.style.opacity = 1;
                return;
            }

            // Display results
            posts.forEach(post => {

                // Display domain in url
                console.log({
                    title: post.title,
                    is_video: post.is_video,
                    domain: post.domain,
                    url: post.url
                });

                // Create result card
                const resultCard = document.createElement('div');
                resultCard.className = 'result-card';

                const title = post.title?.toLowerCase() || '';
                const isProbablyNSFW = post.over_18 || /tits|titties|tiddies|nudes|onlyfans|boobs|cum|cock|cunt|pussy|porn|fuck/.test(title);

                if (isProbablyNSFW) {
                    resultCard.classList.add('nsfw');
                }

                // Create comments section outer shell
                const commentsSection = document.createElement('div');
                commentsSection.className = 'comments-section';

                // Create inner scrollable area
                const commentsScroll = document.createElement('div');
                commentsScroll.className = 'comments-scroll';

                // Put a loading message in the scroll area
                commentsScroll.innerHTML = '<div class="loading-comments">Loading comments...</div>';

                // Append scrollable div inside the outer container
                commentsSection.appendChild(commentsScroll);

                // Fetch comments INTO the inner scrollable div
                fetchComments(post.permalink, commentsScroll);

                // Vote section
                const voteSection = document.createElement('div');
                voteSection.className = 'vote-section';

                const permalinkUrl = `https://www.reddit.com${post.permalink}`;

                const upvoteBtn = document.createElement('a');
                upvoteBtn.href = permalinkUrl;
                upvoteBtn.target = '_blank';
                upvoteBtn.className = 'vote-button';
                upvoteBtn.innerHTML = `
<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <polyline points="18 15 12 9 6 15"></polyline>
</svg>
`;

                const voteCount = document.createElement('div');
                voteCount.className = 'vote-count';
                voteCount.textContent = formatNumber(post.score);

                const downvoteBtn = document.createElement('a');
                downvoteBtn.href = permalinkUrl;
                downvoteBtn.target = '_blank';
                downvoteBtn.className = 'vote-button';
                downvoteBtn.innerHTML = `
<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <polyline points="6 9 12 15 18 9"></polyline>
</svg>
`;

                voteSection.appendChild(upvoteBtn);
                voteSection.appendChild(voteCount);
                voteSection.appendChild(downvoteBtn);

                // Content section
                const contentSection = document.createElement('div');
                contentSection.className = 'content-section';

                // Result header with subreddit, author, time
                const resultHeader = document.createElement('div');
                resultHeader.className = 'result-header';

                const subredditLink = document.createElement('a');
                subredditLink.className = 'result-subreddit';
                subredditLink.href = `https://www.reddit.com/r/${post.subreddit}`;
                subredditLink.target = '_blank';

                // Subreddit icon
                const subredditIcon = document.createElement('div');
                subredditIcon.className = 'subreddit-icon';
                subredditIcon.textContent = post.subreddit.charAt(0).toUpperCase();

                subredditLink.appendChild(subredditIcon);
                subredditLink.appendChild(document.createTextNode('r/' + post.subreddit));

                const authorSpan = document.createElement('span');
                authorSpan.className = 'result-author';
                authorSpan.textContent = 'Posted by u/' + post.author;

                const timeSpan = document.createElement('span');
                timeSpan.className = 'result-time';
                timeSpan.textContent = formatTimestamp(post.created_utc);

                resultHeader.appendChild(subredditLink);
                resultHeader.appendChild(authorSpan);
                resultHeader.appendChild(timeSpan);

                // Result title
                const resultTitle = document.createElement('div');
                resultTitle.className = 'result-title';

                const titleLink = document.createElement('a');
                titleLink.href = `https://www.reddit.com${post.permalink}`;
                titleLink.target = '_blank';
                titleLink.textContent = post.title || 'Comment in thread';

                resultTitle.appendChild(titleLink);

                // Result content (text or snippet)
                const resultContent = document.createElement('div');
                resultContent.className = 'result-content';

                let snippet = '';
                if (post.selftext) {
                    snippet = post.selftext.length > 300
                        ? post.selftext.substring(0, 300) + '...'
                        : post.selftext;
                } else if (post.body) {
                    snippet = post.body.length > 300
                        ? post.body.substring(0, 300) + '...'
                        : post.body;
                }
                // Add sanitization:
                if (snippet) {
                    resultContent.textContent = sanitizeHTML(snippet);
                }

                // Result actions (comments, save, share)
                const resultActions = document.createElement('div');
                resultActions.className = 'result-actions';

                const commentsAction = document.createElement('div');
                commentsAction.className = 'result-action';
                commentsAction.innerHTML = `
                <svg class="action-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    ${post.num_comments || 0} Comments
                `;

                commentsAction.style.cursor = 'pointer';

                commentsAction.addEventListener('click', () => {
                    const url = 'https://www.reddit.com' + post.permalink;
                    window.open(url, '_blank');
                });

                const saveAction = document.createElement('div');
                saveAction.className = 'result-action';
                saveAction.innerHTML = `
                    <svg class="action-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                    </svg>
                    Save
                `;

                const shareAction = document.createElement('div');
                shareAction.className = 'result-action';
                shareAction.innerHTML = `
                    <svg class="action-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="18" cy="5" r="3"></circle>
                        <circle cx="6" cy="12" r="3"></circle>
                        <circle cx="18" cy="19" r="3"></circle>
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                    </svg>
                    Share
                `;

                resultActions.appendChild(commentsAction);
                resultActions.appendChild(saveAction);
                resultActions.appendChild(shareAction);

                // Add all sections to content area
                contentSection.appendChild(resultHeader);
                contentSection.appendChild(resultTitle);

                if (snippet) {
                    contentSection.appendChild(resultContent);
                }

                contentSection.appendChild(resultActions);

                // Add main sections to card
                resultCard.appendChild(voteSection);
                resultCard.appendChild(contentSection);

                // Add thumbnail/preview image if available
                // Create container for image (always needed, even if empty)
                const imgContainer = document.createElement('div');
                imgContainer.className = 'img-container';

                // Add thumbnail/preview image if available

                // Add thumbnail/preview image if available
                const previewImage = post.preview?.images?.[0]?.source?.url?.replace(/&amp;/g, '&');

                if (previewImage) {
                    const imageLink = document.createElement('a');
                    imageLink.href = `https://www.reddit.com${post.permalink}`;
                    imageLink.target = '_blank';

                    // Create image wrapper
                    const imageWrapper = document.createElement('div');
                    imageWrapper.className = 'image-wrapper';

                    // Create shimmer placeholder
                    const imagePlaceholder = document.createElement('div');
                    imagePlaceholder.className = 'image-placeholder shimmer';

                    // Create actual image
                    const resultImage = document.createElement('img');
                    const uniqueTimestamp = `${Date.now()}-${Math.random().toString(36).substring(2, 15)}`;
                    resultImage.src = `https://karmafinder.onrender.com/image?url=${encodeURIComponent(previewImage)}&t=${uniqueTimestamp}`;
                    resultImage.alt = 'Post thumbnail';
                    resultImage.className = 'result-image';

                    // Add cache-preventing attributes
                    resultImage.setAttribute('loading', 'lazy');
                    resultImage.setAttribute('decoding', 'async');
                    resultImage.setAttribute('fetchpriority', 'low');
                    resultImage.setAttribute('crossorigin', 'anonymous');

                    // ðŸ§  Error and silent fail handling with retry
                    resultImage.addEventListener('error', () => {
                        console.error('âŒ Image failed to load at all:', resultImage.src);
                        // Retry with a new timestamp after a short delay
                        setTimeout(() => {
                            const newTimestamp = Date.now();
                            resultImage.src = `https://karmafinder.onrender.com/image?url=${encodeURIComponent(previewImage)}&t=${newTimestamp}`;
                        }, 500);
                    });

                    resultImage.addEventListener('load', () => {
                        if (resultImage.naturalWidth === 0 || resultImage.naturalHeight === 0) {
                            console.warn('âš ï¸ Silent image fail â€” no visible data loaded:', resultImage.src);
                        } else {
                            console.log('ðŸ–¼ï¸ Image loaded and visible:', resultImage.src);
                            imagePlaceholder.style.display = 'none';
                            resultImage.classList.add('show');
                        }
                    });

                    imageWrapper.appendChild(imagePlaceholder);
                    imageWrapper.appendChild(resultImage);
                    imageLink.appendChild(imageWrapper);
                    imgContainer.appendChild(imageLink);
                } else {
                    // No image: make container invisible, but preserve layout
                    imgContainer.style.visibility = 'hidden';
                }

                // Add play icon for video content
                if (
                    post.is_video ||
                    (post.domain && post.domain.includes('youtu')) ||
                    (post.url && post.url.includes('v.redd.it')) ||
                    (post.domain && post.domain.includes('streamable')) ||
                    (post.url && post.url.endsWith('.gifv'))
                ) {
                    const playIcon = document.createElement('div');
                    playIcon.className = 'play-icon';
                    playIcon.innerHTML = 'â–¶';

                    imgContainer.appendChild(playIcon);
                }

                // Add comments section 
                resultCard.appendChild(commentsSection);

                // Add container to result card
                resultCard.appendChild(imgContainer);

                resultsContainer.appendChild(resultCard);

            });

            console.log("Current After:", currentAfter)
            resultsContainer.style.opacity = 1; // ðŸ”¥ Fade new results back in
            updatePagination();
        }


        // Filter NSFW after results load

        const safeSearchSelect = document.getElementById('safesearch-select');
        if (safeSearchSelect?.value === 'on') {
            document.body.classList.add('safe-search-enabled');
        } else {
            document.body.classList.remove('safe-search-enabled');
        }

        function updatePagination() {
            paginationContainer.innerHTML = '';

            const prevButton = document.createElement('button');
            prevButton.className = 'pagination-button';
            prevButton.textContent = 'â† Previous';
            prevButton.disabled = currentPageIndex === 0;
            prevButton.addEventListener('click', () => {
                if (currentPageIndex === 0) {
                    console.warn("âš ï¸ Already on the first page. Can't go back.");
                    return;
                }

                currentPageIndex--; // âœ… Decrement BEFORE calling performSearch()

                const targetPage = navigationHistory[currentPageIndex];
                const prevToken = targetPage.before; // âœ… optional, could be null

                performSearch(null, prevToken, true, targetPage.query); // âœ… passes in token but it's ignored inside performSearch()
            });
            
            paginationContainer.appendChild(prevButton);

            if (currentAfter) {
                const nextButton = document.createElement('button');
                nextButton.className = 'pagination-button';
                nextButton.textContent = 'Next â†’';
                nextButton.disabled = false;
                nextButton.addEventListener('click', () => {
                    const currentPage = navigationHistory[currentPageIndex];
                    const nextToken = currentPage?.nextAfter;

                    if (nextToken) {
                        currentPageIndex++;
                        console.log("ðŸ“ˆ Next -> currentPageIndex has been incremented by:", currentPageIndex);

                        performSearch(nextToken, null, false, currentPage.query);
                    } else {
                        console.warn("No token to go forward.");
                    }
                });

                paginationContainer.appendChild(nextButton);
            }
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp * 1000);
            const now = new Date();
            const diffSeconds = Math.floor((now - date) / 1000);

            if (diffSeconds < 60) {
                return `${diffSeconds} second${diffSeconds !== 1 ? 's' : ''} ago`;
            }

            const diffMinutes = Math.floor(diffSeconds / 60);
            if (diffMinutes < 60) {
                return `${diffMinutes} minute${diffMinutes !== 1 ? 's' : ''} ago`;
            }

            const diffHours = Math.floor(diffMinutes / 60);
            if (diffHours < 24) {
                return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
            }

            const diffDays = Math.floor(diffHours / 24);
            if (diffDays < 30) {
                return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
            }

            const diffMonths = Math.floor(diffDays / 30);
            if (diffMonths < 12) {
                return `${diffMonths} month${diffMonths !== 1 ? 's' : ''} ago`;
            }

            const diffYears = Math.floor(diffMonths / 12);
            return `${diffYears} year${diffYears !== 1 ? 's' : ''} ago`;
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'm';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'k';
            }
            return num.toString();
        }

        // Security function to prevent XSS
        function sanitizeHTML(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const input = document.querySelector('#subreddit-input');
            const dropdown = document.querySelector('.subreddit-suggestions');

            if (input && dropdown) {
                // CLICKING OUTSIDE â†’ closes dropdown
                document.addEventListener('mousedown', (e) => {
                    if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                        dropdown.classList.remove('active');
                    }

                });

                // CLICKING ON A SUGGESTION â†’ apply + close dropdown
                dropdown.addEventListener('click', (e) => {
                    const clickedItem = e.target.closest('.subreddit-suggestion');
                    if (clickedItem) {
                        input.value = clickedItem.dataset.name || clickedItem.innerText;
                        dropdown.classList.remove('active');
                    }
                });
            }
        });
    
                const themeToggle = document.getElementById('themeToggle');
                const icon = document.getElementById('themeIcon');

  // Update icon to match stored theme on page load
  document.addEventListener('DOMContentLoaded', () => {
    const isDark = document.body.classList.contains('dark-mode');
                if (icon) {
                    icon.src = isDark ? 'sun.png' : 'moon.png';
                icon.alt = isDark ? 'Switch to light mode' : 'Switch to dark mode';
    }
  });

  // Toggle logic
  themeToggle.addEventListener('click', () => {
                    document.body.classList.add('theme-transition');

                const isDark = document.body.classList.toggle('dark-mode');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');

                if (icon) {
                    icon.src = isDark ? 'sun.png' : 'moon.png';
                icon.alt = isDark ? 'Switch to light mode' : 'Switch to dark mode';
    }

    setTimeout(() => {
                    document.body.classList.remove('theme-transition');
    }, 300);
   });

   // Initialize default search on page load
    setTimeout(() => {
            console.log("ðŸŒ… Triggering default r/all search after short delay...");
            currentFilters.sort = 'hot';
            currentFilters.time = 'all';
            currentFilters.subreddit = '';
            currentFilters.query = '';
            currentFilters.contentType = 'all';
            currentAfter = null;
            currentBefore = null;
            performSearch(null, null, false, true);
        }, 500);

    </script>

</body>

</html>